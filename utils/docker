#!/bin/bash
set -e

# ===== –ö–û–õ–¨–û–†–ò =====
INFO='\033[0;36m'
OK='\033[0;32m'
WARN='\033[0;33m'
ERR='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${INFO}‚è≥ –ü–æ—á–∏–Ω–∞—î–º–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è Docker —Ç–∞ Docker Compose...${NC}"

# ===== –í–°–¢–ê–ù–û–í–õ–ï–ù–ù–Ø DOCKER =====
if ! command -v docker &>/dev/null; then
  echo -e "${WARN}Docker –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ...${NC}"
  
  sudo apt update
  sudo apt install -y \
    curl \
    ca-certificates \
    apt-transport-https \
    gnupg \
    lsb-release

  # –î–æ–¥–∞—î–º–æ GPG-–∫–ª—é—á
  if [ ! -f /usr/share/keyrings/docker-archive-keyring.gpg ]; then
    curl -fsSL https://download.docker.com/linux/$(. /etc/os-release && echo "$ID")/gpg \
      | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
  fi

  # –î–æ–¥–∞—î–º–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π Docker
  echo \
    "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] \
     https://download.docker.com/linux/$(. /etc/os-release && echo "$ID") \
     $(. /etc/os-release && echo "$VERSION_CODENAME") stable" \
    | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

  # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ Docker
  sudo apt update
  sudo apt install -y docker-ce docker-ce-cli containerd.io

  echo -e "${OK}‚úî Docker –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: $(docker --version)${NC}"
else
  echo -e "${OK}‚úî Docker –≤–∂–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: $(docker --version)${NC}"
fi

# ===== –î–û–î–ê–Ñ–ú–û –ö–û–†–ò–°–¢–£–í–ê–ß–ê –î–û –ì–†–£–ü–ò DOCKER =====
if ! groups $USER | grep -q '\bdocker\b'; then
  echo -e "${WARN}–î–æ–¥–∞—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–æ –≥—Ä—É–ø–∏ docker...${NC}"
  sudo usermod -aG docker $USER
  echo -e "${INFO}üîÅ –ü—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ä–æ–±–æ—Ç–∏ —Å–∫—Ä–∏–ø—Ç–∞ ‚Äî –ø–µ—Ä–µ–ª–æ–≥—ñ–Ω—å—Å—è –∞–±–æ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂ —Å–∏—Å—Ç–µ–º—É.${NC}"
else
  echo -e "${OK}‚úî –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∂–µ —É –≥—Ä—É–ø—ñ docker${NC}"
fi

# ===== –í–°–¢–ê–ù–û–í–õ–ï–ù–ù–Ø DOCKER COMPOSE =====
if ! command -v docker-compose &>/dev/null; then
  echo -e "${WARN}Docker Compose –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ...${NC}"

  sudo apt install -y wget jq

  # –û—Å—Ç–∞–Ω–Ω—è –≤–µ—Ä—Å—ñ—è –∑ GitHub
  COMPOSE_VER=$(wget -qO- https://api.github.com/repos/docker/compose/releases/latest | jq -r ".tag_name")

  # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∫–ª–∞—Å–∏—á–Ω–∏–π docker-compose (–¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ)
  sudo wget -O /usr/local/bin/docker-compose \
    "https://github.com/docker/compose/releases/download/${COMPOSE_VER}/docker-compose-$(uname -s)-$(uname -m)"
  sudo chmod +x /usr/local/bin/docker-compose

  # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Ç–∞–∫–æ–∂ CLI-–ø–ª–∞–≥—ñ–Ω –¥–ª—è –Ω–æ–≤–æ—ó –≤–µ—Ä—Å—ñ—ó
  DOCKER_CLI_PLUGINS=${DOCKER_CLI_PLUGINS:-"$HOME/.docker/cli-plugins"}
  mkdir -p "$DOCKER_CLI_PLUGINS"
  curl -fsSL \
    "https://github.com/docker/compose/releases/download/${COMPOSE_VER}/docker-compose-$(uname -s)-$(uname -m)" \
    -o "${DOCKER_CLI_PLUGINS}/docker-compose"
  chmod +x "${DOCKER_CLI_PLUGINS}/docker-compose"

  echo -e "${OK}‚úî Docker Compose ${COMPOSE_VER} –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ${NC}"
else
  echo -e "${OK}‚úî Docker Compose –≤–∂–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: $(docker-compose --version)${NC}"
fi

# ===== –§–Ü–ù–ê–õ =====
echo -e "${INFO}---------------------------------------------${NC}"
echo -e "${OK}‚úÖ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo -e "${OK}‚û° Docker: $(docker --version)"
echo -e "${OK}‚û° Docker Compose: $(docker-compose --version)"
echo -e "${INFO}üîÅ –ù–µ –∑–∞–±—É–¥—å –ø–µ—Ä–µ–ª–æ–≥—ñ–Ω–∏—Ç–∏—Å—è –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –≥—Ä—É–ø–∏ docker${NC}"
echo -e "${INFO}---------------------------------------------${NC}"
